name: ci

on:
  push:
    branches:
      - main
      - feature/**
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: deadpigeons
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'

      - name: Backend restore
        run: dotnet restore DeadPigeons.sln

      - name: Backend build
        run: dotnet build DeadPigeons.sln --configuration Release --no-restore

      - name: Backend test
        env:
          USE_TESTCONTAINERS: "true"
        run: |
          mkdir -p TestResults
          dotnet test DeadPigeons.sln --configuration Release --no-build \
            --logger "GitHubActions" \
            --logger "trx;LogFileName=test_results.trx" \
            --results-directory "TestResults"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install root dependencies
        run: npm ci

      - name: Frontend install
        run: npm ci --prefix client

      - name: Frontend build
        run: npm run build --prefix client

      - name: Lint client
        run: npm run lint --prefix client

      - name: TypeScript type check
        run: npm run typecheck --prefix client

      - name: Secret scan
        run: npx secretlint "**/*"

      - name: Validate Fly.io configs
        run: |
          test -f fly.api.toml || (echo "fly.api.toml not found" && exit 1)
          test -f client/fly.toml || (echo "client/fly.toml not found" && exit 1)

      - name: Start API for NSwag
        env:
          ConnectionStrings__Default: "Host=localhost;Database=deadpigeons;Username=postgres;Password=postgres"
          Jwt__Secret: "SuperSecretKeyForTestingOnly32Chars!"
          Jwt__Issuer: "DeadPigeons"
          Jwt__Audience: "DeadPigeons"
        run: dotnet run --project server/DeadPigeons.Api --urls "http://localhost:5000" &

      - name: Wait for API to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:5000/swagger/v1/swagger.json > /dev/null; then
              echo "API is ready"
              break
            fi
            echo "Waiting for API... ($i/30)"
            sleep 1
          done

      - name: Install NSwag
        run: dotnet tool install -g NSwag.ConsoleCore --version 14.6.2

      - name: Build API (for NSwag)
        run: dotnet build server/DeadPigeons.Api/DeadPigeons.Api.csproj --configuration Release

      - name: Generate API client
        run: nswag run nswag.json

      - name: Format generated client
        run: npx prettier --write client/src/api/generated/api-client.ts

      - name: Check for API client drift
        run: |
          if git diff --exit-code client/src/api/generated/; then
            echo "API client is up to date"
          else
            echo "ERROR: API client is out of date. Run 'nswag run nswag.json' and commit the changes."
            exit 1
          fi

  deploy-api:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v6

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy API to Fly.io
        run: flyctl deploy --config fly.api.toml --dockerfile server/DeadPigeons.Api/Dockerfile
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Smoke test API
        run: |
          sleep 10
          curl -f https://deadpigeons-api.fly.dev/api/health || exit 1

  deploy-client:
    needs: [build, deploy-api]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v6

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Client to Fly.io
        run: flyctl deploy --config client/fly.toml --dockerfile client/Dockerfile --build-arg VITE_API_URL=https://deadpigeons-api.fly.dev
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Smoke test Client
        run: |
          sleep 10
          curl -f https://deadpigeons-client.fly.dev || exit 1
